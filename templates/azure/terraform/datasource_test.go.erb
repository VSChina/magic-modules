<%# lines(autogen_notice :go) -%>
package azurerm

import (
    "fmt"
    "testing"

    "github.com/hashicorp/terraform/helper/resource"
    "github.com/terraform-providers/terraform-provider-azurerm/azurerm/helpers/tf"
)

<%
    resource_name = object.name
    terraform_name = "azurerm_" + object.name.underscore

    sdk_operation = object.azure_sdk_definition.read
    properties = object.all_user_properties
    input_properties = properties.reject{|p| get_applicable_reference(p.azure_sdk_references, sdk_operation.request).nil?}
    datasource_props = input_properties.map{|p| [p.name.underscore, "${#{terraform_name}.test.#{p.name.underscore}}"]}.to_h

    test_hcls = Hash.new
-%>
<%
    if object.respond_to? :acctests
      object.acctests.each do |test|
        test.steps.uniq.each do |name|
          test_hcl, random_vars = build_test_hcl_from_example(name)
          test_hcls[name] = { :hcl => test_hcl, :random_vars => random_vars }
        end
-%>
func TestAccDataSourceAzureRM<%= resource_name -%>_<%= test.name -%>(t *testing.T) {
    data := acceptance.BuildTestData(t, "<%= terraform_name -%>", "test")

    resource.ParallelTest(t, resource.TestCase{
        PreCheck:     func() { acceptance.PreCheck(t) },
        Providers:    acceptance.SupportedProviders,
        Steps: []resource.TestStep{
<%      test.steps.each do |step| -%>
<%        hcl_params = test_hcls[step][:random_vars].map(&:variable_name).uniq -%>
<%        props_to_check = get_example_properties_to_check(step, object) -%>
            {
                Config: testAccDataSource<%= resource_name -%>_<%= step -%>(data),
                Check: resource.ComposeTestCheckFunc(
<%        props_to_check.each do |propName, propValue| -%>
<%          if propValue == :AttrSet -%>
                    resource.TestCheckResourceAttrSet(data.ResourceName, "<%= propName -%>"),
<%          else -%>
                    resource.TestCheckResourceAttr(data.ResourceName, "<%= propName -%>", "<%= propValue -%>"),
<%          end -%>
<%        end -%>
                ),
            },
<%      end -%>
        },
    })
}
<%    end -%>
<%  end -%>

<%
    if object.respond_to? :acctests
      test_hcls.each do |name, test_hcl|
-%>
func testAccDataSource<%= resource_name -%>_<%= name -%>(data acceptance.TestData) string {
    config := testAccAzureRM<%= resource_name -%>_<%= name -%>(data)
    return fmt.Sprintf(`
%s

data "<%= terraform_name -%>" "test" {
<%= lines(build_hcl_properties(datasource_props)) -%>
}
`, config)
}

<%    end -%>
<%  end -%>